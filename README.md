## Sol Commons on-chain toolkit

Sol Commons ports the analytical Commons Stack toolkit ([commonsstack.org][1]) into Solana. At its heart are

1. **Augmented Bonding Curve (ABC)** – a smart-market maker whose pricing curve sends every contribution into a Reserve Pool for liquidity and a Funding Pool that is immediately spendable by the commons. Buyers mint tokens along the curve, contributors join hatches via allowlists, and every exit returns an exit tribute to the funding pool so the system is self-sustaining.
2. **Conviction Voting** – a continuous governance flow where people lock Commons tokens behind proposals and conviction accumulates proportional to time held; the commons only spends treasury funds once accumulated conviction crosses an adaptive threshold, aligning incentives between contributors and fund recipients.
3. **Commons Assembly/Connected services** – off-chain tools (Praise/Tokenlog/Simulator) surface community recognition, GitHub issue prioritization, and parameter kits that feed into the on-chain ABC + Conviction Voting loop to fund real-world public goods via the commons treasury.

### What this repo provides

| Layer | Description |
|---|---|
| `commons_hatch`, `commons_abc` | Anchor programs that open a Merkle-gated hatch, settle contributions in a vault, and initialize the ABC curve via CPI. The curve tracks a 3-account setup (curve_config PDA, reserve vault, treasury), handles friction splits, and supports refund/claim flows (see existing tests for minted, refunded, and claimed scenarios). |
| `commons_conviction_voting` | Converts the classic CV pattern into Anchor: stakes flow through a global staking vault/PDA, every stake/unstake updates conviction with decay, a helper computes the required conviction threshold, and execution is blocked until the treasury-target ratio is satisfied. Tests cover math correctness and the lifecycle. |
| `commons_rewards` | Merkle-based reward epochs driven by praise—each `RewardEpoch` keeps the vault + PDA bumps so claims can be signed deterministically. The reward CPI signs via derived authority seeds instead of reconstructing random bytes. |
| Off-chain services | Praise, Tokenlog, Simulator scaffolds now export helpers/configs plus integration tests (Mocha + Anchor) so these services can eventually post Merkle roots, GitHub snapshot requests, and simulation parameters. |
| Integration tests | `tests/offchain-integration.js` connects the Node.js scaffolds, while `tests/sol-commons-workspace.ts` shows how praise output becomes a `commons_rewards` epoch using Anchor/`@solana/spl-token`. |

### Example scenarios

1. **Community Hatch + ABC deployment** – The community runs `commons_hatch.initialize` with parameters, an allowlisted Merkle root, and a reserve mint. Contributors deposit during the open window; the finalizer uses `commons_abc.initialize_curve` to mint treasury and reserve vaults, then contributors can claim tokens post-hatch.
2. **Continuous funding via conviction** – Commons token holders stake into proposals via `commons_conviction_voting.stake_tokens`. `update_conviction_for_proposal` keeps a decayed conviction value, and only when the calculated threshold is met does `check_and_execute` approve the request and pay out from the treasury via the CV PDA authority.
3. **Praise → reward epoch** – The off-chain Praise service collects kudos, builds a Merkle batch, and `tests/sol-commons-workspace.ts` demonstrates how that batch becomes a `commons_rewards` epoch tied to a PDA vault with a deterministic mint. Claimers can later pull funds from the vault using the proof generated by the same off-chain service.

### How to get started

1. Install Anchor and run `yarn` in `sol-commons-workspace`; the workspace already includes `@coral-xyz/anchor`, `@solana/spl-token`, and the off-chain scaffolds.
2. Run `yarn test:offchain` to verify the off-chain services are wired together, then `cargo test -p commons_hatch`/`commons_abc`/`commons_conviction_voting`/`commons_rewards` for the on-chain pieces.
3. Use `Anchor.toml` + `cargo test` to deploy locally. Point `offchain/*/config.json` to the deployed programs and trigger the On-chain flows via the integration tests.

### Staying aligned

- `sol-commons-v17`: hatch gating is in place, but consider adding more integration tests to prove contributions obey slot windows and finalization states.
- `sol-commons-2bh`: the scaffolds & integration tests exist, so this issue now becomes implementing real services (e.g., praise aggregator, GitHub tokenlog bot, cadCAD simulator) that exercise the Anchor tests end-to-end.

### Tests

```bash
yarn test:offchain
cargo test -p commons_hatch
cargo test -p commons_abc
cargo test -p commons_conviction_voting
cargo test -p commons_rewards
```
